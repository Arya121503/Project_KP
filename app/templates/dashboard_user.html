<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard User | Telkom Aset</title>

  <!-- Google Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

  <!-- Custom Dashboard CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashUser.css') }}" />
  
  <!-- Custom Telkom Color Scheme -->
  <style>
    :root {
      --telkom-red: #DC143C;
      --telkom-dark: #8B0000;
      --telkom-light: rgba(220, 20, 60, 0.1);
      --color-info-dark: #7d8da1;
      --border-radius-1: 0.4rem;
    }
    
    /* User-specific styling */
    .user-welcome {
      background: linear-gradient(135deg, var(--telkom-red), var(--telkom-dark));
      color: white !important;
      padding: 1.5rem;
      border-radius: var(--border-radius-1);
      margin-bottom: 2rem;
    }
    
    .user-welcome h1,
    .user-welcome p,
    .user-welcome * {
      color: white !important;
    }
    
    .quick-action-card {
      background: white;
      border: 2px solid #f1f1f1;
      transition: all 0.3s ease;
    }
    
    .quick-action-card:hover {
      border-color: var(--telkom-red);
      box-shadow: 0 4px 15px rgba(220, 20, 60, 0.1);
      transform: translateY(-2px);
    }
    
    .asset-card {
      transition: all 0.3s ease;
    }
    
    .asset-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(220, 20, 60, 0.15);
    }
    
    .badge {
      font-size: 0.75rem;
    }
    
    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }
    
    .text-danger {
      color: var(--telkom-red) !important;
    }
    
    .btn-outline-danger {
      border-color: var(--telkom-red);
      color: var(--telkom-red);
    }
    
    .btn-outline-danger:hover {
      background-color: var(--telkom-red);
      border-color: var(--telkom-red);
    }
    
    .bg-danger {
      background-color: var(--telkom-red) !important;
    }
  </style>
</head>
<body>
  <!-- TOP NAVIGATION -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <div class="navbar-left">
        <button class="menu-toggle" id="menu-btn">
          <span class="material-icons-sharp">menu</span>
        </button>
        <button id="sidebar-toggle" class="sidebar-toggle">
          <span class="material-icons-sharp">menu_open</span>
        </button>
        <div class="navbar-brand">
          <img src="{{ url_for('static', filename='img/telkomLogo.png') }}" alt="Telkom Logo" />
          <h2>Telkom<span class="danger"> Aset</span></h2>
        </div>
      </div>

      <div class="navbar-right">
        <div class="dark-mode">
          <span class="material-icons-sharp active">light_mode</span>
          <span class="material-icons-sharp">dark_mode</span>
        </div>
        
        <div class="navbar-nav">
          <div class="nav-item dropdown">
            <a href="#" class="nav-link dropdown-toggle" id="navbarDropdown" role="button" 
               data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">
              <span class="material-icons-sharp">account_circle</span>
              <span class="user-name">{{ session.get('user_name', 'User') }}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
              <li><a class="dropdown-item" href="{{ url_for('main.edit_profile') }}">
                <i class="fas fa-user-edit me-2"></i>Edit Profil & Password
              </a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="{{ url_for('main.logout_user') }}">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
              </a></li>
            </ul>
          </div>
          
          <div class="nav-item">
            <div class="profile-photo">
              <img src="{{ url_for('static', filename='img/profile.jpg') }}" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- SIDEBAR -->
    <aside>
      <div class="sidebar-content">
        <div class="close" id="close-btn">
          <span class="material-icons-sharp">close</span>
        </div>

        <div class="sidebar">
          <a href="#" class="menu-link active" data-target="dashboard-home">
            <span class="material-icons-sharp">dashboard</span>
            <h3>Dashboard</h3>
          </a>
          <a href="#" class="menu-link" data-target="histori-sewa">
            <span class="material-icons-sharp">history</span>
            <h3>Histori Sewa</h3>
          </a>
          <a href="{{ url_for('main.logout_user') }}">
            <span class="material-icons-sharp">logout</span>
            <h3>Logout</h3>
          </a>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main>
      <!-- Dashboard Utama -->
      <section id="dashboard-home" class="content-section active">
        <div class="user-welcome">
          <h1><i class="fas fa-home me-3"></i>Selamat Datang, {{ session.get('user_name', 'User') }}!</h1>
          <p class="mb-0">Temukan aset properti terbaik untuk disewa. Jelajahi berbagai pilihan tanah dan bangunan yang tersedia dari Telkom untuk kebutuhan bisnis Anda.</p>
        </div>
        
        <!-- Aset Tersedia -->
        <div class="card mt-4">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0">
              <i class="fas fa-building me-2"></i>Aset Tersedia untuk Disewa
            </h5>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-4">
                <select class="form-select form-select-sm" id="filterJenis">
                  <option value="">Semua Jenis</option>
                  <option value="tanah">Tanah</option>
                  <option value="tanah_bangunan">Tanah + Bangunan</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-select form-select-sm" id="filterKecamatan">
                  <option value="">Semua Kecamatan</option>
                </select>
              </div>
              <div class="col-md-4">
                <button class="btn btn-sm btn-outline-danger" onclick="loadAsetData()">
                  <i class="fas fa-search me-1"></i>Cari
                </button>
              </div>
            </div>
            
            <div id="asetContainer" class="row g-3">
              <div class="col-12 text-center">
                <div class="spinner-border text-danger" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Memuat data aset...</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Histori Sewa -->
      <section id="histori-sewa" class="content-section">
        <div class="user-welcome">
          <h1><i class="fas fa-history me-3"></i>Histori Sewa Aset</h1>
          <p class="mb-0">Lihat riwayat aset yang pernah Anda sewa dari Telkom. Kelola dan lacak semua transaksi sewa Anda.</p>
        </div>
        
        <!-- Filter Histori -->
        <div class="card mb-4">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0">
              <i class="fas fa-filter me-2"></i>Filter Histori
            </h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">Status Sewa</label>
                <select class="form-select form-select-sm" id="filterStatusHistori">
                  <option value="">Semua Status</option>
                  <option value="aktif">Sedang Aktif</option>
                  <option value="berakhir">Berakhir</option>
                  <option value="dibatalkan">Dibatalkan</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Jenis Aset</label>
                <select class="form-select form-select-sm" id="filterJenisHistori">
                  <option value="">Semua Jenis</option>
                  <option value="tanah">Tanah</option>
                  <option value="tanah_bangunan">Tanah + Bangunan</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Periode</label>
                <select class="form-select form-select-sm" id="filterPeriode">
                  <option value="">Semua Periode</option>
                  <option value="6bulan">6 Bulan Terakhir</option>
                  <option value="1tahun">1 Tahun Terakhir</option>
                  <option value="semua">Semua Waktu</option>
                </select>
              </div>
              <div class="col-md-3">
                <button class="btn btn-sm btn-outline-danger" onclick="loadHistoriData()">
                  <i class="fas fa-search me-1"></i>Cari
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Tabel Histori -->
        <div class="card">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0">
              <i class="fas fa-list me-2"></i>Daftar Histori Sewa
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>No</th>
                    <th>Aset</th>
                    <th>Jenis</th>
                    <th>Periode Sewa</th>
                    <th>Harga/Bulan</th>
                    <th>Status</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="historiSewaTableBody">
                  <tr>
                    <td colspan="7" class="text-center py-4">
                      <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                      <p class="mt-2 mb-0 text-muted">Memuat data histori sewa...</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Custom Dashboard JS -->
  <script src="{{ url_for('static', filename='js/dashUser.js') }}"></script>
  
  <!-- User Dashboard Specific JS -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Load aset data on page load
    loadAsetData();
    loadKecamatanOptions();
    
    // Handle menu navigation
    setupMenuNavigation();
  });

  // Setup menu navigation
  function setupMenuNavigation() {
    const menuLinks = document.querySelectorAll('.menu-link');
    const sections = document.querySelectorAll('.content-section');
    
    menuLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        
        const targetId = this.getAttribute('data-target');
        if (!targetId) return;
        
        // Remove active class from all menu links and sections
        menuLinks.forEach(ml => ml.classList.remove('active'));
        sections.forEach(section => section.classList.remove('active'));
        
        // Add active class to clicked menu and target section
        this.classList.add('active');
        const targetSection = document.getElementById(targetId);
        if (targetSection) {
          targetSection.classList.add('active');
          
          // Load data for specific sections
          if (targetId === 'histori-sewa') {
            loadHistoriData();
          }
        }
      });
    });
  }

  async function loadAsetData() {
    try {
      const filterJenis = document.getElementById('filterJenis').value;
      const filterKecamatan = document.getElementById('filterKecamatan').value;
      
      const params = new URLSearchParams();
      if (filterJenis) params.append('jenis', filterJenis);
      if (filterKecamatan) params.append('kecamatan', filterKecamatan);
      
      const response = await fetch(`/api/aset-tersedia?${params}`);
      const data = await response.json();
      
      if (data.success) {
        displayAsetData(data.data);
      } else {
        showError('Gagal memuat data aset');
      }
    } catch (error) {
      console.error('Error loading aset data:', error);
      showError('Terjadi kesalahan saat memuat data');
    }
  }

  async function loadKecamatanOptions() {
    try {
      const response = await fetch('/api/kecamatan-list');
      const data = await response.json();
      
      if (data.success) {
        const select = document.getElementById('filterKecamatan');
        select.innerHTML = '<option value="">Semua Kecamatan</option>';
        data.data.forEach(kecamatan => {
          select.innerHTML += `<option value="${kecamatan}">${kecamatan}</option>`;
        });
      }
    } catch (error) {
      console.error('Error loading kecamatan options:', error);
    }
  }

  function displayAsetData(asetList) {
    const container = document.getElementById('asetContainer');
    
    if (asetList.length === 0) {
      container.innerHTML = `
        <div class="col-12 text-center">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Tidak ada aset yang tersedia saat ini
          </div>
        </div>
      `;
      return;
    }
    
    let html = '';
    asetList.forEach(aset => {
      html += `
        <div class="col-md-6 col-lg-4">
          <div class="card asset-card h-100 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="badge bg-${aset.jenis === 'tanah' ? 'success' : 'primary'} rounded-pill">
                  ${aset.jenis === 'tanah' ? 'Tanah' : 'Tanah + Bangunan'}
                </span>
                <span class="badge bg-warning text-dark rounded-pill">
                  ${aset.status || 'Tersedia'}
                </span>
              </div>
              
              <h6 class="card-title text-truncate">${aset.alamat || 'Alamat tidak tersedia'}</h6>
              
              <div class="mb-2">
                <small class="text-muted">
                  <i class="fas fa-map-marker-alt me-1"></i>
                  ${aset.kecamatan || 'Kecamatan tidak tersedia'}
                </small>
              </div>
              
              <div class="row text-center mb-3">
                <div class="col-6">
                  <small class="text-muted d-block">Luas Tanah</small>
                  <strong>${aset.luas_tanah || 0} m²</strong>
                </div>
                ${aset.jenis === 'tanah_bangunan' ? `
                <div class="col-6">
                  <small class="text-muted d-block">Luas Bangunan</small>
                  <strong>${aset.luas_bangunan || 0} m²</strong>
                </div>` : '<div class="col-6"></div>'}
              </div>
              
              <div class="text-center">
                <div class="h6 text-danger mb-2">
                  Rp ${formatCurrency(aset.harga_sewa || 0)}/bulan
                </div>
                <button class="btn btn-outline-danger btn-sm" onclick="showAsetDetail(${aset.id})">
                  <i class="fas fa-eye me-1"></i>Lihat Detail
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }

  function showAsetDetail(id) {
    // Create modal for showing asset detail
    fetch(`/api/aset-detail/${id}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showDetailModal(data.data);
        } else {
          alert('Gagal memuat detail aset: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat memuat detail aset');
      });
  }

  function showDetailModal(aset) {
    const modalHTML = `
      <div class="modal fade" id="asetDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title">
                <i class="fas fa-${aset.jenis === 'tanah' ? 'map-marked-alt' : 'building'} me-2"></i>
                Detail ${aset.jenis === 'tanah' ? 'Tanah' : 'Tanah + Bangunan'}
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-danger">Informasi Lokasi</h6>
                  <table class="table table-sm">
                    <tr><td><strong>Alamat:</strong></td><td>${aset.alamat}</td></tr>
                    <tr><td><strong>Kecamatan:</strong></td><td>${aset.kecamatan}</td></tr>
                    <tr><td><strong>Kelurahan:</strong></td><td>${aset.kelurahan}</td></tr>
                  </table>
                </div>
                <div class="col-md-6">
                  <h6 class="text-danger">Spesifikasi</h6>
                  <table class="table table-sm">
                    <tr><td><strong>Luas Tanah:</strong></td><td>${aset.luas_tanah} m²</td></tr>
                    ${aset.luas_bangunan ? `<tr><td><strong>Luas Bangunan:</strong></td><td>${aset.luas_bangunan} m²</td></tr>` : ''}
                    ${aset.kamar_tidur ? `<tr><td><strong>Kamar Tidur:</strong></td><td>${aset.kamar_tidur}</td></tr>` : ''}
                    ${aset.kamar_mandi ? `<tr><td><strong>Kamar Mandi:</strong></td><td>${aset.kamar_mandi}</td></tr>` : ''}
                    ${aset.jumlah_lantai ? `<tr><td><strong>Jumlah Lantai:</strong></td><td>${aset.jumlah_lantai}</td></tr>` : ''}
                  </table>
                </div>
              </div>
              
              <div class="row mt-3">
                <div class="col-12">
                  <h6 class="text-danger">Informasi Harga</h6>
                  <div class="card bg-light">
                    <div class="card-body text-center">
                      <h4 class="text-danger mb-2">Rp ${formatCurrency(aset.harga_sewa)}/bulan</h4>
                      <small class="text-muted">
                        Estimasi berdasarkan nilai properti: Rp ${formatCurrency(aset.harga_prediksi)}
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
              <button type="button" class="btn btn-danger" onclick="contactAdmin('${aset.id}')">
                <i class="fas fa-phone me-1"></i>Hubungi Admin
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('asetDetailModal');
    if (existingModal) {
      existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('asetDetailModal'));
    modal.show();
  }

  function contactAdmin(asetId) {
    alert(`Menghubungi admin untuk aset ${asetId}.\n\nAnda akan diarahkan ke halaman kontak atau form inquiry.`);
    // Di sini bisa diarahkan ke halaman kontak atau membuka form inquiry
  }

  function formatCurrency(number) {
    return new Intl.NumberFormat('id-ID').format(number);
  }

  function showError(message) {
    const container = document.getElementById('asetContainer');
    container.innerHTML = `
      <div class="col-12">
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          ${message}
        </div>
      </div>
    `;
  }

  // ===== HISTORI SEWA FUNCTIONS =====

  async function loadHistoriData() {
    try {
      const filterStatus = document.getElementById('filterStatusHistori').value;
      const filterJenis = document.getElementById('filterJenisHistori').value;
      const filterPeriode = document.getElementById('filterPeriode').value;
      
      const params = new URLSearchParams();
      if (filterStatus) params.append('status', filterStatus);
      if (filterJenis) params.append('jenis', filterJenis);
      if (filterPeriode) params.append('periode', filterPeriode);
      
      const response = await fetch(`/api/histori-sewa?${params}`);
      const data = await response.json();
      
      if (data.success) {
        displayHistoriData(data.data);
      } else {
        showHistoriError('Gagal memuat data histori sewa');
      }
    } catch (error) {
      console.error('Error loading histori data:', error);
      showHistoriError('Terjadi kesalahan saat memuat data');
    }
  }

  function displayHistoriData(historiList) {
    const tbody = document.getElementById('historiSewaTableBody');
    
    if (historiList.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center py-4">
            <i class="fas fa-info-circle text-muted mb-2" style="font-size: 2rem;"></i>
            <p class="text-muted mb-0">Belum ada histori sewa</p>
          </td>
        </tr>
      `;
      return;
    }
    
    let html = '';
    historiList.forEach((item, index) => {
      const statusBadge = getStatusHistoriBadge(item.status);
      const jenisBadge = item.jenis_aset === 'tanah' ? 
        '<span class="badge bg-success">Tanah</span>' : 
        '<span class="badge bg-primary">Tanah + Bangunan</span>';
      
      html += `
        <tr>
          <td>${index + 1}</td>
          <td>
            <div class="fw-semibold">${item.alamat.substring(0, 30)}${item.alamat.length > 30 ? '...' : ''}</div>
            <small class="text-muted">${item.kecamatan}</small>
          </td>
          <td>${jenisBadge}</td>
          <td>
            <div><strong>Mulai:</strong> ${formatDate(item.tanggal_mulai)}</div>
            <div><strong>Berakhir:</strong> ${formatDate(item.tanggal_berakhir)}</div>
          </td>
          <td class="fw-semibold text-success">Rp ${formatCurrency(item.harga_sewa)}</td>
          <td>${statusBadge}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-info" onclick="viewHistoriDetail(${item.id})" title="Lihat Detail">
                <i class="fas fa-eye"></i>
              </button>
              ${item.status === 'aktif' ? 
                `<button class="btn btn-outline-warning" onclick="extendContract(${item.id})" title="Perpanjang">
                  <i class="fas fa-calendar-plus"></i>
                </button>` : ''}
            </div>
          </td>
        </tr>
      `;
    });
    
    tbody.innerHTML = html;
  }

  function getStatusHistoriBadge(status) {
    const badges = {
      'aktif': '<span class="badge bg-success">Aktif</span>',
      'berakhir': '<span class="badge bg-warning text-dark">Berakhir</span>',
      'dibatalkan': '<span class="badge bg-danger">Dibatalkan</span>'
    };
    return badges[status] || '<span class="badge bg-light text-dark">Unknown</span>';
  }

  function showHistoriError(message) {
    const tbody = document.getElementById('historiSewaTableBody');
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center py-4">
          <div class="alert alert-danger mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
          </div>
        </td>
      </tr>
    `;
  }

  function viewHistoriDetail(id) {
    // Simulate detail view for now
    alert(`Melihat detail histori sewa dengan ID: ${id}\n\nFitur ini akan menampilkan detail kontrak, dokumen sewa, dan riwayat pembayaran.`);
    // TODO: Implement actual detail modal
  }

  function extendContract(id) {
    if (confirm('Apakah Anda ingin memperpanjang kontrak sewa ini?')) {
      alert(`Memproses perpanjangan kontrak untuk ID: ${id}\n\nAnda akan diarahkan ke form perpanjangan kontrak.`);
      // TODO: Implement contract extension
    }
  }

  function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('id-ID', {
      day: '2-digit',
      month: '2-digit', 
      year: 'numeric'
    });
  }
  </script>
</body>
</html>